# 画像送信機能 仕様書（Step1拡張）

## 0. 概要

モーダルUIからテキストに加えて**画像も送信**できるようにする機能拡張。
GPT-5のマルチモーダル機能（Vision）を活用し、画像を含むチャットを可能にする。

---

## 1. 目的

- ユーザーが**スクリーンショットや図表**をチャットに添付し、AIに質問・説明を求められるようにする
- 「このエラー画面について教えて」「この図の意味を説明して」といったユースケースに対応

---

## 2. スコープ

### 2.1 In Scope

- モーダルUIへの画像添付機能（ファイル選択 / クリップボードペースト）
- 画像のプレビュー表示・削除
- Backend APIの拡張（画像データ受信 → GPT-5 Vision API呼び出し）
- 画像サイズ・形式のバリデーション

### 2.2 Out of Scope（今回はやらない）

- 複数画像の同時送信（MVP: 1メッセージ1画像）
- 画像の永続化・履歴保存
- 画像編集機能（トリミング、マスキング等）
- ドラッグ&ドロップでの画像添付

---

## 3. 技術的選択肢

### 3.1 画像データの送信方式

| 方式 | メリット | デメリット |
|------|----------|------------|
| **A. Base64埋め込み（JSON）** | 既存APIと互換、実装シンプル | ペイロードサイズ約1.33倍、大きな画像で遅延 |
| **B. multipart/form-data** | バイナリ効率良い | API設計変更大、パース処理追加 |

**おすすめ: A（Base64埋め込み）**
理由：
- 既存の `POST /api/chat` を拡張するだけで対応可能
- GPT-5 Vision APIもBase64形式を受け付ける
- MVP段階では実装のシンプルさを優先

### 3.2 画像取得方法（Front）

| 方式 | 説明 |
|------|------|
| ファイル選択 | `<input type="file">` による選択 |
| クリップボードペースト | `Ctrl+V` でスクリーンショット貼り付け |

**おすすめ: 両方対応**
理由：開発者はスクリーンショットを多用するため、ペースト対応が生産性向上に直結

---

## 4. 機能要件（Front）

### 4.1 UI追加要素

```
┌──────────────────────────────────┐
│  [チャット履歴エリア]            │
│    User: こんにちは              │
│    Assistant: はい、何でしょう？ │
│    User: [画像] このエラーは？   │
│    Assistant: これは...          │
├──────────────────────────────────┤
│  [画像プレビュー] [×削除]        │  ← 添付時のみ表示
├──────────────────────────────────┤
│  [📎] [テキスト入力欄] [送信]    │
│   ↑ 画像添付ボタン               │
└──────────────────────────────────┘
```

### 4.2 画像添付フロー

1. **ファイル選択**
   - 📎ボタンクリック → ファイル選択ダイアログ
   - 対応形式：JPEG, PNG, GIF, WebP
   - 最大サイズ：5MB（要検討）

2. **クリップボードペースト**
   - 入力欄フォーカス中に `Ctrl+V` / `Cmd+V`
   - 画像データがあれば自動添付

3. **プレビュー表示**
   - サムネイル表示（最大150x150px程度）
   - 削除ボタン（×）で添付解除

4. **送信**
   - テキスト + 画像をBackendへ送信
   - 画像のみ（テキスト空）での送信も許可するか？ → **要決定**

### 4.3 バリデーション（Front側）

| 項目 | 制限値 | エラーメッセージ例 |
|------|--------|-------------------|
| ファイルサイズ | 5MB以下 | 「画像は5MB以下にしてください」 |
| ファイル形式 | JPEG/PNG/GIF/WebP | 「対応形式: JPEG, PNG, GIF, WebP」 |
| 画像数 | 1枚/メッセージ | 「画像は1枚まで添付できます」 |

---

## 5. 機能要件（Backend）

### 5.1 API変更

#### `POST /api/chat`（拡張）

**Request（変更後）**
```json
{
  "message": "string",
  "conversationId": "string (optional)",
  "metadata": {
    "url": "string (optional)",
    "title": "string (optional)"
  },
  "image": {
    "data": "string (Base64)",
    "mimeType": "image/jpeg | image/png | image/gif | image/webp"
  }
}
```

- `image` フィールドは任意（後方互換）
- `image.data` はBase64エンコード済み文字列（`data:` プレフィックスなし）
- `image.mimeType` は必須（`image` がある場合）

**Response**
- 変更なし（既存の `ChatResponse` 型を維持）

### 5.2 バリデーション（Backend側）

| 項目 | 制限値 | エラーコード |
|------|--------|-------------|
| Base64デコード後サイズ | 5MB以下 | `INVALID_REQUEST` |
| mimeType | 許可リストに含まれる | `INVALID_REQUEST` |
| Base64形式 | 有効なBase64文字列 | `INVALID_REQUEST` |

### 5.3 LangChain処理

- GPT-5 Vision APIを使用
- メッセージ構造（LangChain形式）:
  ```typescript
  {
    role: "user",
    content: [
      { type: "text", text: "このエラーについて教えて" },
      { type: "image_url", image_url: { url: "data:image/png;base64,..." } }
    ]
  }
  ```

---

## 6. 型定義の変更

### `packages/shared/src/types/chat.ts`

```typescript
// 追加
export type ImageAttachment = {
  data: string      // Base64エンコード済み
  mimeType: "image/jpeg" | "image/png" | "image/gif" | "image/webp"
}

// 変更
export type ChatRequest = {
  message: string
  conversationId?: string
  metadata?: {
    url?: string
    title?: string
  }
  image?: ImageAttachment  // 追加
}
```

---

## 7. エラーハンドリング

### 新規エラーケース

| 状況 | エラーコード | メッセージ例 |
|------|-------------|-------------|
| 画像サイズ超過 | `INVALID_REQUEST` | 「画像サイズは5MB以下にしてください」 |
| 非対応形式 | `INVALID_REQUEST` | 「対応形式: JPEG, PNG, GIF, WebP」 |
| Base64デコード失敗 | `INVALID_REQUEST` | 「画像データが不正です」 |
| Vision API失敗 | `UPSTREAM_ERROR` | 「画像の処理に失敗しました」 |

---

## 8. セキュリティ考慮事項

- **画像データの検証**: Base64デコード後、実際の画像ヘッダ（magic bytes）を検証
- **サイズ制限**: DoS対策として厳格に制限
- **一時保存しない**: 画像はメモリ上で処理し、ディスクに保存しない（MVP）
- **機密情報の露出防止**: エラーメッセージに内部パスやスタックトレースを含めない

---

## 9. 未決定事項（要確認）

以下の点について確認・決定が必要です：

| # | 項目 | 選択肢 | 推奨 |
|---|------|--------|------|
| 1 | テキスト空で画像のみ送信を許可するか | 許可 / 不許可 | 許可（「これは何？」的な使い方を想定） |
| 2 | 画像サイズ上限 | 2MB / 5MB / 10MB | 5MB |
| 3 | 履歴での画像表示 | サムネイル表示 / プレースホルダのみ | サムネイル表示 |
| 4 | 複数画像対応（将来） | 対応予定 / 予定なし | 将来対応（MVP外） |

---

## 10. 受け入れ条件

- [ ] モーダルUIに画像添付ボタン（📎）が表示される
- [ ] ファイル選択から画像を添付できる
- [ ] クリップボードから画像をペーストできる
- [ ] 添付画像のプレビューが表示される
- [ ] プレビューから画像を削除できる
- [ ] 画像付きメッセージを送信し、AIから返答を得られる
- [ ] 非対応形式・サイズ超過時に適切なエラーが表示される
- [ ] チャット履歴に送信した画像が表示される

---

## 11. 関連ドキュメント

- [Backend API仕様](../api/backend-api.md) - API詳細
- [Step1要件定義](./step1-windows.md) - 基本要件
- [shared型定義](../../packages/shared/src/types/chat.ts) - 型の正
